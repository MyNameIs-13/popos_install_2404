---
- name: scrape URL for latest version
  ansible.builtin.uri:
    url: https://api.github.com/repos/{{ user }}/{{ repo }}/releases/latest
    return_content: true
  register: rustdesk_latest
  tags: always

- name: split version out
  ansible.builtin.set_fact:
    rustdesk_latest_version: "{{ rustdesk_latest.json.tag_name }}"
  ignore_errors: "{{ ansible_check_mode }}"
  tags: always

- name: check installed rustdesk version
  ansible.builtin.command: /usr/bin/rustdesk --version
  register: rustdesk_installed_version_output
  ignore_errors: true
  tags: always

- name: save installed rustdesk version as a fact
  ansible.builtin.set_fact:
    rustdesk_installed_version: "{{ rustdesk_installed_version_output.stdout if rustdesk_installed_version_output.rc == 0 else 'not installed' }}"
  ignore_errors: "{{ ansible_check_mode }}"
  tags: always
  when: rustdesk_installed_version_output is defined

- name: display the rustdesk version
  ansible.builtin.debug:
    msg:
      - "installed: {{ rustdesk_installed_version }}"
      - "available: {{ rustdesk_latest_version }}"
  ignore_errors: "{{ ansible_check_mode }}"
  tags: always

- name: install rustdesk
  ansible.builtin.apt:
    deb: https://github.com/{{ user }}/{{ repo }}/releases/download/{{ rustdesk_latest_version }}/rustdesk-{{ rustdesk_latest_version }}-x86_64.deb
  ignore_errors: "{{ ansible_check_mode }}"
  become: True
  tags: always
  when: rustdesk_installed_version != rustdesk_latest_version
