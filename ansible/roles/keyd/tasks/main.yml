---
- name: keyd
  block:
    - name: creates /etc/keyd
      ansible.builtin.file:
        path: /etc/keyd
        state: directory

    - name: create keyd config file
      ansible.builtin.copy:
        dest: /etc/keyd/default.conf
        content: |
          [ids]

          *

          [main]

          rightalt = layer(dia)

          [dia]

          # Map o to Ã¶
          o = Ã¶

          # Map a to Ã¤
          a = Ã¤

          # Map u to Ã¼
          u = Ã¼

          # Map s to ÃŸ
          s = ÃŸ

          # Map v to Â¥
          v = Â¥

          # Map b to Â£
          b = Â£

          # Map e to â‚¬
          e = â‚¬

          # Map w to Ã¨
          w = Ã¨

          # Map r to Ã©
          r = Ã©

          # Map t to Ãª
          t = Ãª

          # Map y to Ã«
          y = Ã«

          # Map c to Ã§
          c = Ã§

          # Map h to spock hand
          h = ğŸ––

          # Map k to poo
          k = ğŸ’©

          # Map 0 to â°
          0 = â°

          # Map 1 to Â¹
          1 = Â¹

          # Map 2 to Â²
          2 = Â²

          # Map 3 to Â³
          3 = Â³

          # Map 4 to â´
          4 = â´

          # Map 5 to âµ
          5 = âµ

          # Map 6 to â¶
          6 = â¶

          # Map 7 to â·
          7 = â·

          # Map 8 to â¸
          8 = â¸

          # Map 9 to â¹
          9 = â¹

          # Map d to Â°
          d = Â°

          # Map i to âˆ
          i = âˆ

          # Map < to Â«
          < = Â«

          # Map > to Â»
          > = Â»

          # Map z to Î±
          z = Î±

          # Map x to Î²
          x = Î²

          # Map pi to Ï€
          p = Ï€

          # Map l to Î»
          l = Î»

          # Map m to Âµ
          m = Âµ

    - name: ensure compose:menu
      ansible.builtin.lineinfile:
        path: /etc/vconsole.conf
        regexp: "^XKBOPTIONS="
        line: XKBOPTIONS=,compose:menu
        mode: "0644"

    - name: install required packages
      ansible.builtin.apt:
        name:
          - cmake
          - make
        state: present

    - name: clone the keyd repository
      ansible.builtin.git:
        repo: https://github.com/rvaiya/keyd
        dest: /usr/local/keyd
      register: keyd_git_status
      ignore_errors: "{{ ansible_check_mode }}"

    - name: when git repo changed
      block:
        - name: check if '/usr/local' is already in git safe.directory
          ansible.builtin.command: "git config --global --get-all safe.directory"
          register: keyd_git_safe_directory
          ignore_errors: true # If there are no safe.directory entries, this will avoid failing the playbook.

        - name: add '/usr/local' to git safe.directory if not present
          ansible.builtin.command: "git config --global --add safe.directory '/usr/local'"
          when: "'/usr/local' not in keyd_git_safe_directory.stdout_lines"

        - name: git clean
          ansible.builtin.command: git clean -f
          args:
            chdir: /usr/local/keyd

        - name: make
          ansible.builtin.command: make
          args:
            chdir: /usr/local/keyd

        - name: make install
          ansible.builtin.command: make install
          args:
            chdir: /usr/local/keyd

        - name: enable keyd
          ansible.builtin.systemd:
            name: keyd
            state: "started"
            enabled: true

        # BUG: module was rename but does not work yet in  2.10.8
        # - name: enable keyd
        #   ansible.builtin.systemd_service:
        #     name: keyd
        #     state: "started"
        #     enabled: true
      when: keyd_git_status.changed
  tags: always
  become: true
  when: ansible_distribution_version == "24.04"
