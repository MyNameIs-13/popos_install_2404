---
- name: keyd
  block:
    - name: creates /etc/keyd
      ansible.builtin.file:
        path: /etc/keyd
        state: directory

    - name: create keyd config file
      ansible.builtin.copy:
        dest: /etc/keyd/default.conf
        content: |
          [ids]

          *

          [main]

          rightalt = layer(dia)

          [dia]

          # Map o to ö
          o = ö

          # Map a to ä
          a = ä

          # Map u to ü
          u = ü

          # Map s to ß
          s = ß

          # Map v to ¥
          v = ¥

          # Map b to £
          b = £

          # Map e to €
          e = €

          # Map w to è
          w = è

          # Map r to é
          r = é

          # Map t to ê
          t = ê

          # Map y to ë
          y = ë

          # Map c to ç
          c = ç

          # Map h to spock hand
          h = 🖖

          # Map k to poo
          k = 💩

          # Map 0 to ⁰
          0 = ⁰

          # Map 1 to ¹
          1 = ¹

          # Map 2 to ²
          2 = ²

          # Map 3 to ³
          3 = ³

          # Map 4 to ⁴
          4 = ⁴

          # Map 5 to ⁵
          5 = ⁵

          # Map 6 to ⁶
          6 = ⁶

          # Map 7 to ⁷
          7 = ⁷

          # Map 8 to ⁸
          8 = ⁸

          # Map 9 to ⁹
          9 = ⁹

          # Map d to °
          d = °

          # Map i to ∞
          i = ∞

          # Map < to «
          < = «

          # Map > to »
          > = »

          # Map z to α
          z = α

          # Map x to β
          x = β

          # Map pi to π
          p = π

          # Map l to λ
          l = λ

          # Map m to µ
          m = µ

    - name: ensure compose:menu
      ansible.builtin.lineinfile:
        path: /etc/vconsole.conf
        regexp: "^XKBOPTIONS="
        line: XKBOPTIONS=,compose:menu
        mode: "0644"

    - name: install required packages
      ansible.builtin.apt:
        name:
          - cmake
          - make
        state: present

    - name: clone the keyd repository
      ansible.builtin.git:
        repo: https://github.com/rvaiya/keyd
        dest: /usr/local/keyd
      register: keyd_git_status
      ignore_errors: "{{ ansible_check_mode }}"

    - name: when git repo changed
      block:
        - name: check if '/usr/local' is already in git safe.directory
          ansible.builtin.command: "git config --global --get-all safe.directory"
          register: keyd_git_safe_directory
          ignore_errors: true # If there are no safe.directory entries, this will avoid failing the playbook.

        - name: add '/usr/local' to git safe.directory if not present
          ansible.builtin.command: "git config --global --add safe.directory '/usr/local'"
          when: "'/usr/local' not in keyd_git_safe_directory.stdout_lines"

        - name: git clean
          ansible.builtin.command: git clean -f
          args:
            chdir: /usr/local/keyd

        - name: make
          ansible.builtin.command: make
          args:
            chdir: /usr/local/keyd

        - name: make install
          ansible.builtin.command: make install
          args:
            chdir: /usr/local/keyd

        - name: enable keyd
          ansible.builtin.systemd:
            name: keyd
            state: "started"
            enabled: true

        # BUG: module was rename but does not work yet in  2.10.8
        # - name: enable keyd
        #   ansible.builtin.systemd_service:
        #     name: keyd
        #     state: "started"
        #     enabled: true
      when: keyd_git_status.changed
  tags: always
  become: true
  when: ansible_distribution_version == "24.04"
