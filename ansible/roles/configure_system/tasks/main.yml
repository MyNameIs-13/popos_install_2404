---
- name: set timezone to Europe/Brussels
  timezone:
    name: Europe/Brussels
  tags: always

- name: add Hack nerdfont
  ansible.builtin.include_tasks:
    file: hack-font.yml
  vars:
    user: "ryanoasis"
    repo: "nerd-fonts"
  tags: always

- name: configure firewall rules
  ansible.builtin.include_tasks:
    file: firewall.yml
  tags: always

- name: configure hibernation
  ansible.builtin.include_tasks:
    file: hibernation.yml
  tags: always
  when: ("gui" is in ansible_run_tags)

- name: configure automatic switch batterty and ac profile
  ansible.builtin.include_tasks:
    file: autopowerprofile.yml
  tags: always

- name: upgrade recovery partition
  block:
    - name: "upgrade recovery partition : check the current day"
      ansible.builtin.shell: "echo $(($(date '+%d')%7))"
      register: current_day

    - name: "upgrade recovery partition : execute upgrade"
      ansible.builtin.command: pop-upgrade recovery upgrade from-release
      ignore_errors: "{{ ansible_check_mode }}"
      when: current_day.stdout | int == 1
  tags: always
  when:
    - ansible_distribution == "Pop!_OS"
    - ansible_distribution_version == "22.04"

- name: add syncthing repo, install and start
  block:
    - name: get syncthing key, save in /usr/share/keyrings for newer apt deb syntax
      ansible.builtin.get_url:
        url: https://syncthing.net/release-key.gpg
        dest: /usr/share/keyrings/syncthing-archive-keyring.gpg
        mode: "0666"

    - name: add syncthing apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable"
        state: present
        filename: syncthing
        update_cache: yes
        mode: "0644"
        validate_certs: yes
      when: ansible_architecture == "x86_64"

    - name: add syncthing apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=arm64 signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable"
        state: present
        filename: syncthing
        update_cache: yes
        mode: "0644"
        validate_certs: yes
      when: ansible_architecture == "aarch64"

    - name: install syncthing
      ansible.builtin.apt:
        state: present
        name: syncthing
      ignore_errors: "{{ ansible_check_mode }}" # --check cannot validate that the package is available as the repo is not yet added

    - name: enable syncthing
      ansible.builtin.systemd:
        name: syncthing@{{ main_user }}.service
        state: "started"
        enabled: true
  become: true
  tags: home

- name: framework fanctrl
  block:
    - name: clone the gamescope repository
      ansible.builtin.git:
        repo: https://github.com/MyNameIs-13/fw-fanctrl.git
        dest: /opt/fw-fanctrl
      register: fw_fanctrl_git_status
      ignore_errors: "{{ ansible_check_mode }}"

    - name: when git repo changed
      block:
        - name: check if '/opt' is already in git safe.directory
          ansible.builtin.command: "git config --global --get-all safe.directory"
          register: fw_fanctrl_git_safe_directory
          ignore_errors: true # If there are no safe.directory entries, this will avoid failing the playbook.

        - name: add '/opt' to git safe.directory if not present
          ansible.builtin.command: "git config --global --add safe.directory '/opt'"
          when: "'/opt' not in fw_fanctrl_git_safe_directory.stdout_lines"

        - name: install fw-fanctrl
          ansible.builtin.command: install.sh
          args:
            chdir: /opt/fw-fanctrl
      when: fw_fanctrl_git_status.changed
  become: true
  tags: framework
  when: ansible_distribution_version == "24.04"
