---
- name: Add syncthing repo, install and start
  tags: home
  block:
    - name: Add syncthing apt repository
      ansible.builtin.deb822_repository:
        name: syncthing
        types: deb
        uris: https://apt.syncthing.net/
        suites: stable
        components: syncthing
        architectures: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
        signed_by: https://syncthing.net/release-key.gpg
      when: ansible_architecture == "aarch64"

    - name: Install syncthing
      ansible.builtin.apt:
        state: present
        name: syncthing
      ignore_errors: "{{ ansible_check_mode }}" # --check cannot validate that the package is available as the repo is not yet added

    - name: Add --no-default-folder
      ansible.builtin.lineinfile:
        path: /usr/lib/systemd/system/syncthing@.service
        regexp: "^ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --logflags=0"
        line: ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --no-default-folder --logflags=0

    - name: Enable syncthing
      ansible.builtin.systemd:
        name: syncthing@{{ main_user }}.service
        state: "started"
        enabled: true
